{% extends "base.html" %}

{% block title %}게시글 작성 - 자유게시판{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for(request, 'static', path='/css/freeboardWrite.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="write-header">
        <h1>게시글 작성</h1>
        <p class="write-description">자유게시판에 새 글을 작성합니다</p>
    </div>

    <!-- 에러 메시지 -->
    {% if error_message %}
    <div class="error-alert">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>
        <span>{{ error_message }}</span>
    </div>
    {% endif %}

    <!-- 작성 폼 -->
    <form action="{{ url_for(request, 'board_write_submit') }}" method="post" enctype="multipart/form-data" class="write-form">
        <!-- 제목 -->
        <div class="form-group">
            <label for="boardTitle" class="form-label">제목 <span class="required">*</span></label>
            <input 
                type="text" 
                id="boardTitle" 
                name="board_title" 
                class="form-input" 
                placeholder="제목을 입력하세요"
                value="{{ board_title if board_title else '' }}"
                required
                maxlength="300"
            >
        </div>

        <!-- 내용 -->
        <div class="form-group">
            <label for="boardContent" class="form-label">내용 <span class="required">*</span></label>
            <textarea 
                id="boardContent" 
                name="board_content" 
                class="form-textarea" 
                placeholder="내용을 입력하세요"
                required
                rows="15"
            >{{ board_content if board_content else '' }}</textarea>
        </div>

        <!-- 이미지 업로드 -->
        <div class="form-group">
            <label for="images" class="form-label">이미지 첨부 (최대 5개)</label>
            <div class="image-upload-area">
                <input 
                    type="file" 
                    id="images" 
                    name="images" 
                    accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
                    multiple
                    class="file-input"
                    onchange="previewImages(event)"
                >
                <label for="images" class="file-label">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>이미지 선택</span>
                    <span class="file-hint">jpg, png, gif, webp (최대 10MB)</span>
                </label>
            </div>

            <!-- 이미지 미리보기 -->
            <div id="imagePreview" class="image-preview-container"></div>
        </div>

        <!-- 버튼 -->
        <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="history.back()">취소</button>
            <button type="submit" class="btn-submit">작성 완료</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 이미지 미리보기
let selectedFiles = [];

function previewImages(event) {
    const files = Array.from(event.target.files);
    const previewContainer = document.getElementById('imagePreview');
    
    // 최대 5개 제한
    if (files.length > 5) {
        alert('이미지는 최대 5개까지 업로드 가능합니다.');
        event.target.value = '';
        return;
    }
    
    // 파일 크기 검증 (10MB)
    const maxSize = 10 * 1024 * 1024;
    for (let file of files) {
        if (file.size > maxSize) {
            alert(`파일 크기는 10MB를 초과할 수 없습니다. (${file.name})`);
            event.target.value = '';
            return;
        }
    }
    
    selectedFiles = files;
    previewContainer.innerHTML = '';
    
    files.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${e.target.result}" alt="미리보기 ${index + 1}">
                <div class="preview-info">
                    <span class="preview-name">${file.name}</span>
                    <span class="preview-order">${index === 0 ? '썸네일' : `이미지 ${index + 1}`}</span>
                </div>
                <button type="button" class="btn-remove" onclick="removeImage(${index})">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            previewContainer.appendChild(previewItem);
        };
        
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    // DataTransfer를 사용해서 파일 목록 재구성
    const dt = new DataTransfer();
    const input = document.getElementById('images');
    const files = Array.from(input.files);
    
    files.forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    input.files = dt.files;
    
    // 미리보기 재생성
    previewImages({ target: input });
}

// 폼 제출 전 검증
document.querySelector('.write-form').addEventListener('submit', (e) => {
    const title = document.getElementById('boardTitle').value.trim();
    const content = document.getElementById('boardContent').value.trim();
    
    if (!title) {
        alert('제목을 입력해주세요.');
        e.preventDefault();
        return;
    }
    
    if (!content) {
        alert('내용을 입력해주세요.');
        e.preventDefault();
        return;
    }
    
    // 제출 중 표시
    const submitBtn = document.querySelector('.btn-submit');
    submitBtn.disabled = true;
    submitBtn.textContent = '작성 중...';
});
</script>
{% endblock %}
